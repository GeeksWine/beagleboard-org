<?xml version="1.0" encoding="ISO-8859-1"?>
<?xml-stylesheet type="text/xsl" href="helma.xsl"?>
<xmlroot xmlns:hop="http://www.helma.org/docs/guide/features/database">
  <hopobject id="3008" name="accelerometer" prototype="Page" created="1375888514900" lastModified="1375908834238">
  <hop:parent idref="2892" prototyperef="Page"/>
    <is_xhtml type="boolean">true</is_xhtml>
    <http_remotehost>127.0.0.1</http_remotehost>
    <http_language>en-US,en;q=0.8</http_language>
    <uri>accelerometer</uri>
    <http_browser>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.95 Safari/537.36</http_browser>
    <time type="date">07.08.2013 15:53:54 CDT</time>
    <hopsession>127.0.0.192.94.94.1r02ohpk32194</hopsession>
    <body>&lt;h1&gt;&lt;a href=&quot;http://processingjs.org/&quot; class=&quot;external&quot;&gt;Processing.JS&lt;/a&gt;&lt;/h1&gt;
&lt;canvas id=&quot;mysketch&quot;&gt;&lt;/canvas&gt;
&lt;script src=&quot;/static/bonescript.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;/static/processing.js&quot;&gt;&lt;/script&gt;
&lt;script&gt;
(function(){
var canvas = document.getElementById(&apos;mysketch&apos;);
var pjs = new Processing(canvas);

// Global variables
var radius = 50.0;
var X, Y;
var nX, nY;
var delay = 16;
var brightness = 0;
var buttonStatus = false;
var LED_RED = &apos;P9_42&apos;;
var LED_GREEN = &apos;P9_14&apos;;
var LED_BLUE = &apos;P9_16&apos;;
var BUTTON = &apos;P8_19&apos;;
var POT = &apos;P9_36&apos;;

// Get the BoneScript library and begin updating the canvas
setTargetAddress(&apos;192.168.7.2&apos;, {initialized: run});
function run() {
    var b = require(&apos;bonescript&apos;);
    var port = &apos;/dev/i2c-2&apos;
    var address = 0x1c;
    b.pinMode(LED_RED, b.OUTPUT);
    b.pinMode(LED_GREEN, b.OUTPUT);
    b.pinMode(LED_BLUE, b.OUTPUT);
    b.pinMode(BUTTON, b.INPUT);
    b.i2cOpen(port, address, {}, onI2C);
    
    function onI2C() {
        b.i2cWriteBytes(port, 0x2a, [0x00]);
        b.i2cWriteBytes(port, 0x0e, [0x07]);
        b.i2cWriteBytes(port, 0x2a, [0x01]);
    }

    // Setup the Processing Canvas
    pjs.setup = function() {
        pjs.size(255, 255);
        pjs.strokeWeight(10);
        pjs.frameRate(15);
        X = pjs.width / 2;
        Y = pjs.height / 2;
        nX = X;
        nY = Y;  
    }
    
    // Main draw loop
    pjs.draw = function() {
        // Calculate some fading values based on the frame count
        radius = 50.0 + 10.0*pjs.sin(pjs.frameCount / 4);
        brightness = (radius - 40.0) / 20.0;
        
        // Set the RGB LED color based on the status of the button
        if(buttonStatus) {
            b.analogWrite(LED_RED, brightness);
            b.analogWrite(LED_BLUE, 0);
        } else {
            b.analogWrite(LED_RED, 0);            
            b.analogWrite(LED_BLUE, brightness);
        }
      
        // Track circle to new destination
        X+=(nX-X)/delay;
        Y+=(nY-Y)/delay;
      
        // Fill canvas grey
        pjs.background(100);
      
        // Set fill-color to blue or red, based on button status
        if(buttonStatus) pjs.fill(200, 30, 20)
        else pjs.fill(0, 121, 184);
      
        // Set stroke-color white
        pjs.stroke(255); 
      
        // Draw circle
        pjs.ellipse(X, Y, radius, radius);
        
        // Fetch slider location for next time
        //b.analogRead(POT, onAnalogRead);
        b.i2cReadBytes(port, 1, 6, onReadBytes);
        
        // Fetch button status
        b.digitalRead(BUTTON, onDigitalRead);
    }
    
    // Handle data back from potentiometer
    function onAnalogRead(x) {
        if(!x.err &amp;&amp; (x.value &gt;= 0) &amp;&amp; (x.value &lt;= 1)) {
            nY = x.value * pjs.height;    
        }
    }
    
    function onWriteByte(x) {
        if(x.event == &apos;callback&apos;) {
            b.i2cReadBytes(port, 1, 6, onReadBytes);
        }
    }
    
    function onReadBytes(x) {
        if(x.event == &apos;callback&apos;) {
            nX = x.res[0];
            nY = x.res[2];
            if(nX &gt;= 128) nX = -~nX;
            if(nY &gt;= 128) nY = -~nY;
            nX += 128;
            nY += 128;
            $(&apos;#nX&apos;).html(nX);
            $(&apos;#nY&apos;).html(nY);
        }
    }
    
    // Handle data back from button
    function onDigitalRead(x) {
        buttonStatus = (x.value == b.LOW) ? true : false;
    }
    
    pjs.setup();
}

})();
&lt;/script&gt;
&lt;p&gt;nX = &lt;span id=&quot;nX&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;nY = &lt;span id=&quot;nY&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;div style=&quot;clear:both;&quot;&gt;&lt;/div&gt;</body>
    <pseudoparent idref="2892" prototyperef="Page"/>
    <http_referer>http://beagleboard.org/support/BoneScript/processingjs/accelerometer/edit</http_referer>
    <http_host>beagleboard.org</http_host>
    <user>jkridner@gmail.com</user>
    <lang>en-us</lang>
  </hopobject>
</xmlroot>
