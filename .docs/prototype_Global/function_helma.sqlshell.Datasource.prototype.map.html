<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>

<head>
	<title></title>
	<style type="text/css">

	body, p, td, th, li {
		font-family: verdana, sans-serif;
		font-size: 10pt;
	}

	big.top {
		font-size: 18pt;
		font-weight: bold;
	}

	big {
		font-size: 13pt;
		font-weight: bold;
	}
	
	a {
		font-weight:bold;
		color: #cc3333;
		text-decoration:none;
	}
	a:hover	{
		text-decoration:underline;
	}

	.navig	{
		font-size: 9px;
		text-decoration: none;
		font-weight:normal;
	}
	
	li {
		padding-bottom: 5px;
	}
	

	.mainbox	{
		border-color:#999999;
		padding-top:5px;
		padding-bottom:5px;
		border-bottom-width:1px;
		border-bottom-style:dotted;
	}	

	.headline {
		font-weight:bold;
		background:#dfdfdf;
		border-color:#999999;
		padding-top:5px;
		padding-bottom:5px;
	}	

	</style>
</head>

<body>

<table width="90%" border="0" cellspacing="1" cellpadding="5">
<tr>
	<td class="headline">
	<big><tt>Global.helma.sqlshell.Datasource.prototype.map&nbsp;(meta,&nbsp;schema,&nbsp;con,&nbsp;param)</tt></big><br>
	</td>
</tr>

<tr>
	<td class="mainbox">
	
	
	<ul>
		
		
		
		
		
		
	</ul>
	</td>
</tr>
</table>

<table width="90%" border="0" cellspacing="1" cellpadding="5">
<tr>
	<td>Sourcecode in helmaTools.zip/Global/helma.sqlshell.js:
	<pre><font color="#aaaaaa">418:</font>   helma.sqlshell.Datasource.prototype.map = function(meta, schema, con, param) {
<font color="#aaaaaa">419:</font>   <font color="#33aa00">    // for (var i in req.data) res.debug(i);
<font color="#aaaaaa">420:</font>   </font>    res.push();
<font color="#aaaaaa">421:</font>       res.data.prototypes = this.getPrototypes();
<font color="#aaaaaa">422:</font>       var proto = app.getPrototype(req.data.__sqlshell_prototype__);
<font color="#aaaaaa">423:</font>       if (proto) {
<font color="#aaaaaa">424:</font>           var tableStyle = { table: { <font color="#9999aa">&quot;class&quot;</font>: <font color="#9999aa">&quot;map&quot;</font> }, td: { <font color="#9999aa">&quot;class&quot;</font>: <font color="#9999aa">&quot;map&quot;</font> } };
<font color="#aaaaaa">425:</font>           var dbmap = proto.getDbMapping();
<font color="#aaaaaa">426:</font>           if (!req.data.__sqlshell_table__ ||
<font color="#aaaaaa">427:</font>                  req.data.__sqlshell_prototype__ != req.data.previousProto) {
<font color="#aaaaaa">428:</font>              req.data.__sqlshell_table__ = dbmap.tableName;
<font color="#aaaaaa">429:</font>          }
<font color="#aaaaaa">430:</font>          param.tableSelect = renderSkinAsString(createSkin('Map to table \
<font color="#aaaaaa">431:</font>          <font color="#aa3300">&lt;% html.select name=<font color="#9999aa">&quot;__sqlshell_table__&quot;</font> options=<font color="#9999aa">&quot;response.tables&quot;</font> \
<font color="#aaaaaa">432:</font>           onchange=<font color="#9999aa">&quot;document.forms.tab.submit();&quot;</font>%&gt;</font>'));
<font color="#aaaaaa">433:</font>      }
<font color="#aaaaaa">434:</font>      renderSkin(<font color="#9999aa">&quot;helma.sqlshell#map&quot;</font>, param);
<font color="#aaaaaa">435:</font>      if (proto) {
<font color="#aaaaaa">436:</font>          var maptypes = [<font color="#9999aa">&quot;Primitive&quot;</font>, <font color="#9999aa">&quot;Reference&quot;</font>, <font color="#9999aa">&quot;Collection&quot;</font>, <font color="#9999aa">&quot;Mountpoint&quot;</font>];
<font color="#aaaaaa">437:</font>          var tableStyle = { table: { <font color="#9999aa">&quot;class&quot;</font>: <font color="#9999aa">&quot;map&quot;</font> }, td: { <font color="#9999aa">&quot;class&quot;</font>: <font color="#9999aa">&quot;map&quot;</font> } };
<font color="#aaaaaa">438:</font>          if (req.data.__sqlshell_table__) {
<font color="#aaaaaa">439:</font>              var primKey = <font color="#9999aa">&quot;&quot;</font>;
<font color="#aaaaaa">440:</font>              try {
<font color="#aaaaaa">441:</font>                  var k = meta.getPrimaryKeys(null, schema, req.data.__sqlshell_table__);
<font color="#aaaaaa">442:</font>                  if (k.next()) {
<font color="#aaaaaa">443:</font>                      primKey = k.getString(4);
<font color="#aaaaaa">444:</font>                  }
<font color="#aaaaaa">445:</font>                  if (k.next()) {
<font color="#aaaaaa">446:</font>                      helma.Markup.p({<font color="#9999aa">&quot;class&quot;</font>: <font color="#9999aa">&quot;error&quot;</font>}, <font color="#9999aa">&quot;Table has composed primary key!&quot;</font>);
<font color="#aaaaaa">447:</font>                  }
<font color="#aaaaaa">448:</font>              } catch (error) {
<font color="#aaaaaa">449:</font>                  helma.Markup.p({<font color="#9999aa">&quot;class&quot;</font>: <font color="#9999aa">&quot;error&quot;</font>}, <font color="#9999aa">&quot;Error retrieving primary key: &quot;</font> + error);
<font color="#aaaaaa">450:</font>              }
<font color="#aaaaaa">451:</font>              var t = meta.getColumns(null, schema, req.data.__sqlshell_table__, <font color="#9999aa">&quot;%&quot;</font>);
<font color="#aaaaaa">452:</font>              var columns = [];
<font color="#aaaaaa">453:</font>              res.data.columns = [[<font color="#9999aa">&quot;&quot;</font>, <font color="#9999aa">&quot;&quot;</font>]];
<font color="#aaaaaa">454:</font>              while (t.next()) {
<font color="#aaaaaa">455:</font>                  var colname = t.getString(4);
<font color="#aaaaaa">456:</font>                  columns.push(colname);
<font color="#aaaaaa">457:</font>                  res.data.columns.push([colname, colname]);
<font color="#aaaaaa">458:</font>              }
<font color="#aaaaaa">459:</font>              var writer = new helma.Markup.TableWriter(2, tableStyle);
<font color="#aaaaaa">460:</font>              writer.write(<font color="#9999aa">&quot;Extends &quot;</font>);
<font color="#aaaaaa">461:</font>              var ext = dbmap.getExtends() || app.getPrototype(<font color="#9999aa">&quot;hopobject&quot;</font>).name;
<font color="#aaaaaa">462:</font>              writer.write(helma.Markup.Select({name: <font color="#9999aa">&quot;__sqlshell_extends__&quot;</font>}, res.data.prototypes, ext));
<font color="#aaaaaa">463:</font>              writer.write(<font color="#9999aa">&quot;Primary key column &quot;</font>);
<font color="#aaaaaa">464:</font>              writer.write(helma.Markup.Select({name: <font color="#9999aa">&quot;__sqlshell_primaryKey__&quot;</font>}, res.data.columns, primKey));
<font color="#aaaaaa">465:</font>              writer.write(<font color="#9999aa">&quot;Prototype column &quot;</font>);
<font color="#aaaaaa">466:</font>              writer.write(helma.Markup.Select({name: <font color="#9999aa">&quot;__sqlshell_protoColumn__&quot;</font>}, res.data.columns, dbmap.prototypeField));
<font color="#aaaaaa">467:</font>              writer.write(<font color="#9999aa">&quot;Name column &quot;</font>);
<font color="#aaaaaa">468:</font>              writer.write(helma.Markup.Select({name: <font color="#9999aa">&quot;__sqlshell_nameColumn__&quot;</font>}, res.data.columns, dbmap.nameField));
<font color="#aaaaaa">469:</font>              writer.write(<font color="#9999aa">&quot;Parent Descriptor &quot;</font>);
<font color="#aaaaaa">470:</font>              writer.write(helma.Markup.Input({name: <font color="#9999aa">&quot;__sqlshell_parent__&quot;</font>, value: dbmap.parentSetting, size: 60}));
<font color="#aaaaaa">471:</font>              writer.close();
<font color="#aaaaaa">472:</font>              tableStyle = { table: { <font color="#9999aa">&quot;class&quot;</font>: <font color="#9999aa">&quot;map&quot;</font>, id: <font color="#9999aa">&quot;maptable&quot;</font> }, td: { <font color="#9999aa">&quot;class&quot;</font>: <font color="#9999aa">&quot;map&quot;</font> } };
<font color="#aaaaaa">473:</font>              writer = new helma.Markup.TableWriter(5, tableStyle);
<font color="#aaaaaa">474:</font>              writer.writeHeader = true;
<font color="#aaaaaa">475:</font>              var headers = [<font color="#9999aa">&quot;Column Name&quot;</font>, <font color="#9999aa">&quot;Property Name&quot;</font>, <font color="#9999aa">&quot;Mapping&quot;</font>,
<font color="#aaaaaa">476:</font>                      <font color="#9999aa">&quot;Target Prototype&quot;</font>, <font color="#9999aa">&quot;Extras&quot;</font>];
<font color="#aaaaaa">477:</font>              for (var c in headers) {
<font color="#aaaaaa">478:</font>                  writer.write(headers[c]);
<font color="#aaaaaa">479:</font>              }
<font color="#aaaaaa">480:</font>              for (var col in columns) {
<font color="#aaaaaa">481:</font>                  var colname = columns[col];
<font color="#aaaaaa">482:</font>  <font color="#33aa00">                // if (colname == primKey) continue;
<font color="#aaaaaa">483:</font>  </font>                var rel = dbmap.columnNameToRelation(colname);
<font color="#aaaaaa">484:</font>                  var value = rel &amp;&amp; rel.propName ? rel.propName : this.toCamelCase(colname);
<font color="#aaaaaa">485:</font>                  var type = rel ? rel.refType : 0;
<font color="#aaaaaa">486:</font>                  var targetDisplay = type &gt; 0 ? <font color="#9999aa">''</font>: ' style=<font color="#9999aa">&quot;display: none;&quot;</font>';
<font color="#aaaaaa">487:</font>                  var target = rel &amp;&amp; rel.targetType ? rel.targetType.typeName : proto.name;
<font color="#aaaaaa">488:</font>                  writer.write(colname);
<font color="#aaaaaa">489:</font>                  writer.write('&lt;input name=<font color="#9999aa">&quot;' + colname + '&quot;</font> value=<font color="#9999aa">&quot;' + value +'&quot;</font>&gt;');
<font color="#aaaaaa">490:</font>                  writer.write(helma.Markup.Select({name: <font color="#9999aa">&quot;maptype_&quot;</font> + colname,
<font color="#aaaaaa">491:</font>                      onchange: <font color="#9999aa">&quot;toggleEditor(this)&quot;</font>}, maptypes, type));
<font color="#aaaaaa">492:</font>                  writer.write('&lt;div id=<font color="#9999aa">&quot;refedit_' + colname + '&quot;</font>' + targetDisplay +'&gt;' +
<font color="#aaaaaa">493:</font>                               helma.Markup.Select({name: <font color="#9999aa">&quot;target_&quot;</font> + colname}, res.data.prototypes, target) + '&lt;/div&gt;');
<font color="#aaaaaa">494:</font>                  var buffer = new java.lang.StringBuffer();
<font color="#aaaaaa">495:</font>                  var config = rel ? wrapJavaMap(rel.config) : {local: colname, foreign: primKey};
<font color="#aaaaaa">496:</font>                  for (var i in this.mappingOptions) {
<font color="#aaaaaa">497:</font>  <font color="#33aa00">                    // var name = i.replace('_', '.');
<font color="#aaaaaa">498:</font>  </font>                    var name = colname + <font color="#9999aa">&quot;_&quot;</font> + i;
<font color="#aaaaaa">499:</font>                      buffer.append(helma.Markup.Hidden({id: name, name: name, value: config[i] }).toString());
<font color="#aaaaaa">500:</font>                  }
<font color="#aaaaaa">501:</font>                  buffer.append(helma.Markup.A({href: this.href() + <font color="#9999aa">&quot;&amp;action=extras&amp;col=&quot;</font> + colname,
<font color="#aaaaaa">502:</font>                      id:<font color="#9999aa">&quot;extralink_&quot;</font> + colname, style: type &gt; 0 ? <font color="#9999aa">''</font>: 'display: none;',
<font color="#aaaaaa">503:</font>                      onclick: <font color="#9999aa">&quot;openExtraEditor(this.href, '&quot;</font> + colname + <font color="#9999aa">&quot;'); return false;&quot;</font>},
<font color="#aaaaaa">504:</font>                          <font color="#9999aa">&quot;edit&quot;</font>).toString());
<font color="#aaaaaa">505:</font>                  writer.write(buffer);
<font color="#aaaaaa">506:</font>              }
<font color="#aaaaaa">507:</font>              var href = this.href();
<font color="#aaaaaa">508:</font>              var renderCollection = function(rel, options) {
<font color="#aaaaaa">509:</font>                  if (!rel || rel.refType &lt; 1 || (rel.dbField &amp;&amp; rel.dbField != primKey)) {
<font color="#aaaaaa">510:</font>                      return;
<font color="#aaaaaa">511:</font>                  }
<font color="#aaaaaa">512:</font>                  var propName = rel.propName;
<font color="#aaaaaa">513:</font>                  var target = rel.targetType ? rel.targetType.typeName : <font color="#9999aa">&quot;&quot;</font>;
<font color="#aaaaaa">514:</font>                  var type = rel.refType;
<font color="#aaaaaa">515:</font>                  if (type == 3) {
<font color="#aaaaaa">516:</font>  <font color="#33aa00">                    // FIXME TODO: we do not handle complex references yet
<font color="#aaaaaa">517:</font> </font>                    return;
<font color="#aaaaaa">518:</font>                 }
<font color="#aaaaaa">519:</font>                 if (type == 2 &amp;&amp; !rel.dbField) {
<font color="#aaaaaa">520:</font> <font color="#33aa00">                    // helma does not separate between collections and mountpoints internally
<font color="#aaaaaa">521:</font> </font>                    type = 3;
<font color="#aaaaaa">522:</font>                 }
<font color="#aaaaaa">523:</font>                 var colname = <font color="#9999aa">&quot;collection_&quot;</font> + (collectionCount++);
<font color="#aaaaaa">524:</font>                 writer.write(<font color="#9999aa">&quot;&quot;</font>);
<font color="#aaaaaa">525:</font>                 writer.write('&lt;input name=<font color="#9999aa">&quot;' + colname + '&quot;</font> value=<font color="#9999aa">&quot;' + propName +'&quot;</font>&gt;');
<font color="#aaaaaa">526:</font>                 writer.write(helma.Markup.Select({name: <font color="#9999aa">&quot;maptype_&quot;</font> + colname,
<font color="#aaaaaa">527:</font>                     onchange: <font color="#9999aa">&quot;toggleEditor(this)&quot;</font>}, maptypes, type));
<font color="#aaaaaa">528:</font>                 writer.write('&lt;div id=<font color="#9999aa">&quot;refedit_' + colname + '&quot;</font>&gt;' +
<font color="#aaaaaa">529:</font>                              helma.Markup.Select({name: <font color="#9999aa">&quot;target_&quot;</font> + colname}, res.data.prototypes, target) + '&lt;/div&gt;');
<font color="#aaaaaa">530:</font>                 var buffer = new java.lang.StringBuffer();
<font color="#aaaaaa">531:</font>                 var config = wrapJavaMap(rel.config);
<font color="#aaaaaa">532:</font>                 for (var i in options) {
<font color="#aaaaaa">533:</font> <font color="#33aa00">                    // var name = i.replace('_', '.');
<font color="#aaaaaa">534:</font> </font>                    var name = colname + <font color="#9999aa">&quot;_&quot;</font> + i;
<font color="#aaaaaa">535:</font>                     buffer.append(helma.Markup.Hidden({id: name, name: name, value: config[i] }).toString());
<font color="#aaaaaa">536:</font>                 }
<font color="#aaaaaa">537:</font>                 buffer.append(helma.Markup.A({href: href + <font color="#9999aa">&quot;&amp;action=extras&amp;col=&quot;</font> + colname,
<font color="#aaaaaa">538:</font>                     id:<font color="#9999aa">&quot;extralink_&quot;</font> + colname,
<font color="#aaaaaa">539:</font>                     onclick: <font color="#9999aa">&quot;openExtraEditor(this.href, '&quot;</font> + colname + <font color="#9999aa">&quot;'); return false;&quot;</font>},
<font color="#aaaaaa">540:</font>                         <font color="#9999aa">&quot;edit&quot;</font>).toString());
<font color="#aaaaaa">541:</font>                 writer.write(buffer);
<font color="#aaaaaa">542:</font>             }
<font color="#aaaaaa">543:</font>             var props = dbmap.getPropertyNames();
<font color="#aaaaaa">544:</font>             var collectionCount = 0;
<font color="#aaaaaa">545:</font>             renderCollection(dbmap.getSubnodeRelation(), this.mappingOptions);
<font color="#aaaaaa">546:</font>             for (var p in props) {
<font color="#aaaaaa">547:</font>                 renderCollection(dbmap.propertyToRelation(props[p]), this.mappingOptions);
<font color="#aaaaaa">548:</font>             }
<font color="#aaaaaa">549:</font>             writer.close();
<font color="#aaaaaa">550:</font> <font color="#33aa00">            // FIXME: AJAX to the rescue! **********************************
<font color="#aaaaaa">551:</font> </font>            res.writeln('&lt;script type=<font color="#9999aa">&quot;text/javascript&quot;</font>&gt;');
<font color="#aaaaaa">552:</font>             res.writeln('var colcount = ' + collectionCount + ';');
<font color="#aaaaaa">553:</font>             res.write('var rowtemplate = \'&lt;td class=<font color="#9999aa">&quot;map&quot;</font>&gt;&lt;/td&gt;&lt;td class=<font color="#9999aa">&quot;map&quot;</font>&gt;&lt;input name=<font color="#9999aa">&quot;$$$&quot;</font> value=<font color="#9999aa">&quot;&quot;</font>&gt;&lt;/td&gt;');
<font color="#aaaaaa">554:</font>             res.write('&lt;td class=<font color="#9999aa">&quot;map&quot;</font>&gt;')
<font color="#aaaaaa">555:</font>             helma.Markup.select({name: <font color="#9999aa">&quot;maptype_$$$&quot;</font>,
<font color="#aaaaaa">556:</font>                 onchange: <font color="#9999aa">&quot;toggleEditor(this)&quot;</font>}, maptypes, 2);
<font color="#aaaaaa">557:</font>             res.write('&lt;/td&gt;&lt;td class=<font color="#9999aa">&quot;map&quot;</font>&gt;')
<font color="#aaaaaa">558:</font>             res.write('&lt;div id=<font color="#9999aa">&quot;refedit_$$$&quot;</font>&gt;' +
<font color="#aaaaaa">559:</font>                          helma.Markup.Select({name: <font color="#9999aa">&quot;target_$$$&quot;</font>}, res.data.prototypes, target) + '&lt;/div&gt;');
<font color="#aaaaaa">560:</font>             res.write('&lt;/td&gt;&lt;td class=<font color="#9999aa">&quot;map&quot;</font>&gt;')
<font color="#aaaaaa">561:</font>             for (var i in this.mappingOptions) {
<font color="#aaaaaa">562:</font> <font color="#33aa00">                // var name = i.replace('_', '.');
<font color="#aaaaaa">563:</font> </font>                var name = <font color="#9999aa">&quot;$$$_&quot;</font> + i;
<font color="#aaaaaa">564:</font>                 helma.Markup.hidden({id: name, name: name, value: <font color="#9999aa">&quot;&quot;</font> });
<font color="#aaaaaa">565:</font>             }
<font color="#aaaaaa">566:</font>             helma.Markup.a({href: this.href() + <font color="#9999aa">&quot;&amp;action=extras&amp;col=$$$&quot;</font>,
<font color="#aaaaaa">567:</font>                 id:<font color="#9999aa">&quot;extralink_$$$&quot;</font>,
<font color="#aaaaaa">568:</font>                 onclick: <font color="#9999aa">&quot;openExtraEditor(this.href, \\'$$$\\'); return false;&quot;</font>},
<font color="#aaaaaa">569:</font>                     <font color="#9999aa">&quot;edit&quot;</font>);
<font color="#aaaaaa">570:</font>             res.write('&lt;/td&gt;');
<font color="#aaaaaa">571:</font>             res.writeln(<font color="#9999aa">&quot;';&quot;</font>);
<font color="#aaaaaa">572:</font>             res.writeln('&lt;/script&gt;');
<font color="#aaaaaa">573:</font> <font color="#33aa00">            // END FIXME **********************************
<font color="#aaaaaa">574:</font> </font>            helma.Markup.a({href: <font color="#9999aa">&quot;#&quot;</font>, onclick:'return appendTableRow(<font color="#9999aa">&quot;maptable&quot;</font>);'}, <font color="#9999aa">&quot;Add Collection&quot;</font>);
<font color="#aaaaaa">575:</font>             res.write(<font color="#9999aa">&quot; &quot;</font>);
<font color="#aaaaaa">576:</font>             helma.Markup.submit({name: <font color="#9999aa">&quot;generateMapping&quot;</font>,
<font color="#aaaaaa">577:</font>                 onclick:<font color="#9999aa">&quot;submitFormToPopup(document.forms.tab, '&quot;</font> + this.href() + <font color="#9999aa">&quot;&amp;action=generate', 'generate',500,350); return false;&quot;</font>,
<font color="#aaaaaa">578:</font>                 value: <font color="#9999aa">&quot;Generate Mapping&quot;</font>}
<font color="#aaaaaa">579:</font>             );
<font color="#aaaaaa">580:</font>         }
<font color="#aaaaaa">581:</font>     }
<font color="#aaaaaa">582:</font>     return res.pop();
<font color="#aaaaaa">583:</font> }
</pre>
	</td>
</tr>

</table>





</body>
</html>
