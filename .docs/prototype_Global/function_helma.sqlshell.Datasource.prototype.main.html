<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>

<head>
	<title></title>
	<style type="text/css">

	body, p, td, th, li {
		font-family: verdana, sans-serif;
		font-size: 10pt;
	}

	big.top {
		font-size: 18pt;
		font-weight: bold;
	}

	big {
		font-size: 13pt;
		font-weight: bold;
	}
	
	a {
		font-weight:bold;
		color: #cc3333;
		text-decoration:none;
	}
	a:hover	{
		text-decoration:underline;
	}

	.navig	{
		font-size: 9px;
		text-decoration: none;
		font-weight:normal;
	}
	
	li {
		padding-bottom: 5px;
	}
	

	.mainbox	{
		border-color:#999999;
		padding-top:5px;
		padding-bottom:5px;
		border-bottom-width:1px;
		border-bottom-style:dotted;
	}	

	.headline {
		font-weight:bold;
		background:#dfdfdf;
		border-color:#999999;
		padding-top:5px;
		padding-bottom:5px;
	}	

	</style>
</head>

<body>

<table width="90%" border="0" cellspacing="1" cellpadding="5">
<tr>
	<td class="headline">
	<big><tt>Global.helma.sqlshell.Datasource.prototype.main&nbsp;()</tt></big><br>
	</td>
</tr>

<tr>
	<td class="mainbox">
	
	
	<ul>
		
		
		
		
		
		
	</ul>
	</td>
</tr>
</table>

<table width="90%" border="0" cellspacing="1" cellpadding="5">
<tr>
	<td>Sourcecode in helmaTools.zip/Global/helma.sqlshell.js:
	<pre><font color="#aaaaaa">177:</font>   helma.sqlshell.Datasource.prototype.main = function() {
<font color="#aaaaaa">178:</font>       res.handlers.datasource = this;
<font color="#aaaaaa">179:</font>       if (!req.data.__sqlshell_tab__) {
<font color="#aaaaaa">180:</font>           req.data.__sqlshell_tab__ = <font color="#9999aa">&quot;explore&quot;</font>;
<font color="#aaaaaa">181:</font>       }
<font color="#aaaaaa">182:</font>       res.data.tabcolor = helma.sqlshell.colors[req.data.__sqlshell_tab__];
<font color="#aaaaaa">183:</font>   
<font color="#aaaaaa">184:</font>       var param = new Object();
<font color="#aaaaaa">185:</font>       param.action = this.href();
<font color="#aaaaaa">186:</font>  
<font color="#aaaaaa">187:</font>  <font color="#33aa00">    // get connection
<font color="#aaaaaa">188:</font>  </font>    var con = this.datasource.getConnection();
<font color="#aaaaaa">189:</font>  
<font color="#aaaaaa">190:</font>  <font color="#33aa00">    // get database meta data
<font color="#aaaaaa">191:</font>  </font>    var meta = con.getMetaData();
<font color="#aaaaaa">192:</font>  
<font color="#aaaaaa">193:</font>      res.data.datasources = helma.sqlshell.getDatasources();
<font color="#aaaaaa">194:</font>      res.data.schemas = this.getSchemas(meta);
<font color="#aaaaaa">195:</font>      var schema = req.data.__sqlshell_schema__;
<font color="#aaaaaa">196:</font>      res.data.tables = this.getTables(meta, schema);
<font color="#aaaaaa">197:</font>  
<font color="#aaaaaa">198:</font>      if (req.data.action) {
<font color="#aaaaaa">199:</font>          app.data.repositories = helma.sqlshell.getRepositories();
<font color="#aaaaaa">200:</font>          if (req.data.action == <font color="#9999aa">&quot;createproto&quot;</font> ) {
<font color="#aaaaaa">201:</font>              var repos = app.repositories[req.data.repository];
<font color="#aaaaaa">202:</font>              var file = new File(repos.directory.toString(), req.data.protoname);
<font color="#aaaaaa">203:</font>              if (file.mkdir()) {
<font color="#aaaaaa">204:</font>  
<font color="#aaaaaa">205:</font>                  renderSkin(<font color="#9999aa">&quot;helma.sqlshell#closePopup&quot;</font>, {
<font color="#aaaaaa">206:</font>                      parentUrl: this.href() + <font color="#9999aa">&quot;&amp;__sqlshell_prototype__=&quot;</font> + req.data.protoname,
<font color="#aaaaaa">207:</font>                      message: <font color="#9999aa">&quot;&lt;p&gt;Created directory &quot;</font> + file + <font color="#9999aa">&quot;&lt;/p&gt;&quot;</font> +
<font color="#aaaaaa">208:</font>                               <font color="#9999aa">&quot;&lt;p&gt;Please wait for prototypes to be updated...&lt;/p&gt;&quot;</font>
<font color="#aaaaaa">209:</font>                  } );
<font color="#aaaaaa">210:</font>                  return;
<font color="#aaaaaa">211:</font>              } else {
<font color="#aaaaaa">212:</font>                  res.debug(<font color="#9999aa">&quot;Couldn't create directory: &quot;</font> + file);
<font color="#aaaaaa">213:</font>                  res.data.body = renderSkinAsString(<font color="#9999aa">&quot;helma.sqlshell#newproto&quot;</font>, param);
<font color="#aaaaaa">214:</font>              }
<font color="#aaaaaa">215:</font>          } else if (req.data.action == <font color="#9999aa">&quot;extras&quot;</font>) {
<font color="#aaaaaa">216:</font>              var p = {};
<font color="#aaaaaa">217:</font>              var t = app.getPrototype(req.data.target);
<font color="#aaaaaa">218:</font>              var target = t &amp;&amp; t.dbMapping ? t.dbMapping.tableName : null;
<font color="#aaaaaa">219:</font>              p.targetColumns = this.getColumns(meta, schema, target).toSource();
<font color="#aaaaaa">220:</font>              p.localColumns = this.getColumns(meta, schema, req.data.__sqlshell_table__).toSource();
<font color="#aaaaaa">221:</font>              res.data.body = renderSkinAsString(<font color="#9999aa">&quot;helma.sqlshell#extras&quot;</font>, p);
<font color="#aaaaaa">222:</font>          } else if (req.data.action == <font color="#9999aa">&quot;generate&quot;</font>) {
<font color="#aaaaaa">223:</font>              if (req.data.create) {
<font color="#aaaaaa">224:</font>                  renderSkin(<font color="#9999aa">&quot;helma.sqlshell#closePopup&quot;</font>, {
<font color="#aaaaaa">225:</font>                      parentUrl: this.href() + <font color="#9999aa">&quot;&amp;prototype=&quot;</font> + req.data.__sqlshell_prototype__,
<font color="#aaaaaa">226:</font>                      message: <font color="#9999aa">&quot;&lt;p&gt;Created type mapping &quot;</font> + file + <font color="#9999aa">&quot;&lt;/p&gt;&quot;</font> +
<font color="#aaaaaa">227:</font>                               <font color="#9999aa">&quot;&lt;p&gt;Please wait for prototypes to be updated...&lt;/p&gt;&quot;</font>
<font color="#aaaaaa">228:</font>                  } );
<font color="#aaaaaa">229:</font>              } else {
<font color="#aaaaaa">230:</font>                  var fields = {};
<font color="#aaaaaa">231:</font>                  var s = new java.lang.StringBuffer();
<font color="#aaaaaa">232:</font>                  for (var i in req.postParams) {
<font color="#aaaaaa">233:</font>                      if (i.indexOf(<font color="#9999aa">&quot;maptype_&quot;</font>) == 0) {
<font color="#aaaaaa">234:</font>                          fields[i.substring(8)] = req.postParams[i];
<font color="#aaaaaa">235:</font>                      }
<font color="#aaaaaa">236:</font>                      s.append(helma.Markup.Hidden({name: i, value: req.postParams[i] }).toString());
<font color="#aaaaaa">237:</font>                  }
<font color="#aaaaaa">238:</font>                  if (req.data.__sqlshell_create__) {
<font color="#aaaaaa">239:</font>  <font color="#33aa00">                    // res.data.body = renderSkinAsString(<font color="#9999aa">&quot;helma.sqlshell#generate&quot;</font>), p);
<font color="#aaaaaa">240:</font>  </font>                    var repos = app.getPrototype(req.data.__sqlshell_prototype__).repositories;
<font color="#aaaaaa">241:</font>                      var resName = <font color="#9999aa">&quot;type.properties&quot;</font>;
<font color="#aaaaaa">242:</font>                      for (var i in repos) {
<font color="#aaaaaa">243:</font>                          var resource = repos[i].getResource(resName);
<font color="#aaaaaa">244:</font>                          if (resource &amp;&amp; resource.exists()) {
<font color="#aaaaaa">245:</font>                              if (resource.getClass() == Packages.helma.framework.repository.FileResource) {
<font color="#aaaaaa">246:</font>                                  var file = new File(resource.getName());
<font color="#aaaaaa">247:</font>                                  var backup = new File(resource.getName() + <font color="#9999aa">&quot;.bak&quot;</font>);
<font color="#aaaaaa">248:</font>                                  if (backup.exists()) {
<font color="#aaaaaa">249:</font>                                      var n = 1;
<font color="#aaaaaa">250:</font>                                      do {
<font color="#aaaaaa">251:</font>                                          backup = new File(resource.getName() + <font color="#9999aa">&quot;.bak.&quot;</font> + n++)
<font color="#aaaaaa">252:</font>                                      } while (backup.exists());
<font color="#aaaaaa">253:</font>                                  }
<font color="#aaaaaa">254:</font>                                  if (!file.renameTo(backup)) {
<font color="#aaaaaa">255:</font>                                      res.debug(<font color="#9999aa">&quot;ERROR: Couldn't create backup for &quot;</font> + resource);
<font color="#aaaaaa">256:</font>                                  }
<font color="#aaaaaa">257:</font>                              } else {
<font color="#aaaaaa">258:</font>                                  res.debug(<font color="#9999aa">&quot;WARNING: Couldn't move &quot;</font> + resource);
<font color="#aaaaaa">259:</font>                              }
<font color="#aaaaaa">260:</font>                          }
<font color="#aaaaaa">261:</font>                      }
<font color="#aaaaaa">262:</font>                      var file = new File(repos[req.data.__sqlshell_repository__].getResource(resName).getName());
<font color="#aaaaaa">263:</font>                      file.open();
<font color="#aaaaaa">264:</font>                      file.writeln(<font color="#9999aa">&quot;# Created by Helma SqlShell at &quot;</font> + new Date());
<font color="#aaaaaa">265:</font>                      file.writeln(<font color="#9999aa">&quot;_db = &quot;</font> + req.data.__sqlshell_datasource__);
<font color="#aaaaaa">266:</font>                      file.writeln(<font color="#9999aa">&quot;_table = &quot;</font> + req.data.__sqlshell_table__);
<font color="#aaaaaa">267:</font>                      if (req.data.__sqlshell_extends__)
<font color="#aaaaaa">268:</font>                          file.writeln(<font color="#9999aa">&quot;_extends = &quot;</font> + req.data.__sqlshell_extends__);
<font color="#aaaaaa">269:</font>                      if (req.data.__sqlshell_primaryKey__)
<font color="#aaaaaa">270:</font>                          file.writeln(<font color="#9999aa">&quot;_id = &quot;</font> + req.data.__sqlshell_primaryKey__);
<font color="#aaaaaa">271:</font>                      if (req.data.__sqlshell_protoColumn__)
<font color="#aaaaaa">272:</font>                          file.writeln(<font color="#9999aa">&quot;_prototype = &quot;</font> + req.data.__sqlshell_protoColumn__);
<font color="#aaaaaa">273:</font>                      if (req.data.__sqlshell_nameColumn__)
<font color="#aaaaaa">274:</font>                          file.writeln(<font color="#9999aa">&quot;_name = &quot;</font> + req.data.__sqlshell_nameColumn__);
<font color="#aaaaaa">275:</font>                      if (req.data.__sqlshell_parent__)
<font color="#aaaaaa">276:</font>                         file.writeln(<font color="#9999aa">&quot;_parent = &quot;</font> + req.data.__sqlshell_parent__);
<font color="#aaaaaa">277:</font>                     file.writeln(<font color="#9999aa">&quot;&quot;</font>);
<font color="#aaaaaa">278:</font>                     var writeMapping = function(type, options) {
<font color="#aaaaaa">279:</font>                         for (var i in fields) {
<font color="#aaaaaa">280:</font>                             if (parseInt(fields[i]) != type)
<font color="#aaaaaa">281:</font>                                 continue;
<font color="#aaaaaa">282:</font>                             var propName = req.data[i];
<font color="#aaaaaa">283:</font>                             if (!propName)
<font color="#aaaaaa">284:</font>                                 continue;
<font color="#aaaaaa">285:</font>                             file.write(propName);
<font color="#aaaaaa">286:</font>                             file.write(<font color="#9999aa">&quot; = &quot;</font>);
<font color="#aaaaaa">287:</font>                             switch (type) {
<font color="#aaaaaa">288:</font>                             case 0:
<font color="#aaaaaa">289:</font>                                 file.writeln(req.data[i]);
<font color="#aaaaaa">290:</font>                                 break;
<font color="#aaaaaa">291:</font>                             case 1:
<font color="#aaaaaa">292:</font>                                 file.writeln(<font color="#9999aa">&quot;object(&quot;</font> + req.data[<font color="#9999aa">&quot;target_&quot;</font> + i] + <font color="#9999aa">&quot;)&quot;</font>);
<font color="#aaaaaa">293:</font>                                 break;
<font color="#aaaaaa">294:</font>                             case 2:
<font color="#aaaaaa">295:</font>                                 file.writeln(<font color="#9999aa">&quot;collection(&quot;</font> + req.data[<font color="#9999aa">&quot;target_&quot;</font> + i] + <font color="#9999aa">&quot;)&quot;</font>);
<font color="#aaaaaa">296:</font>                                 break;
<font color="#aaaaaa">297:</font>                             case 3:
<font color="#aaaaaa">298:</font>                                 file.writeln(<font color="#9999aa">&quot;mountpoint(&quot;</font> + req.data[<font color="#9999aa">&quot;target_&quot;</font> + i] + <font color="#9999aa">&quot;)&quot;</font>);
<font color="#aaaaaa">299:</font>                                 break;
<font color="#aaaaaa">300:</font>                             default:
<font color="#aaaaaa">301:</font>                                 res.debug(i + <font color="#9999aa">&quot;: &quot;</font> + fields[i]);
<font color="#aaaaaa">302:</font>                             }
<font color="#aaaaaa">303:</font>                             for (var m in options) {
<font color="#aaaaaa">304:</font>                                 if (options[m] &lt;= type &amp;&amp; req.data[i + <font color="#9999aa">&quot;_&quot;</font> + m]) {
<font color="#aaaaaa">305:</font>                                     file.write(propName);
<font color="#aaaaaa">306:</font>                                     file.write(<font color="#9999aa">&quot;.&quot;</font>);
<font color="#aaaaaa">307:</font>                                     file.write(m.replace(<font color="#9999aa">&quot;_&quot;</font>, <font color="#9999aa">&quot;.&quot;</font>));
<font color="#aaaaaa">308:</font>                                     file.write(<font color="#9999aa">&quot; = &quot;</font>);
<font color="#aaaaaa">309:</font>                                     file.writeln(req.data[i + <font color="#9999aa">&quot;_&quot;</font> + m]);
<font color="#aaaaaa">310:</font>                                 }
<font color="#aaaaaa">311:</font>                             }
<font color="#aaaaaa">312:</font>                             if (type &gt; 0) file.writeln(<font color="#9999aa">&quot;&quot;</font>);
<font color="#aaaaaa">313:</font>                         }
<font color="#aaaaaa">314:</font>                     };
<font color="#aaaaaa">315:</font>                     writeMapping(0);
<font color="#aaaaaa">316:</font>                     file.writeln(<font color="#9999aa">&quot;&quot;</font>);
<font color="#aaaaaa">317:</font>                     writeMapping(1, this.mappingOptions);
<font color="#aaaaaa">318:</font>                     writeMapping(2, this.mappingOptions);
<font color="#aaaaaa">319:</font>                     writeMapping(3, this.mappingOptions);
<font color="#aaaaaa">320:</font>                     file.close();
<font color="#aaaaaa">321:</font>                     res.data.body = <font color="#9999aa">&quot;Successfully created mapping in &lt;a href='file://&quot;</font>
<font color="#aaaaaa">322:</font>                             + file + <font color="#9999aa">&quot;'&gt;&quot;</font> + file + <font color="#9999aa">&quot;&lt;/a&gt;&quot;</font>;
<font color="#aaaaaa">323:</font>                 } else {
<font color="#aaaaaa">324:</font>                     var p = {
<font color="#aaaaaa">325:</font>                         data: s.toString(),
<font color="#aaaaaa">326:</font>                         href: this.href()
<font color="#aaaaaa">327:</font>                     };
<font color="#aaaaaa">328:</font>                     res.data.repositories = helma.sqlshell.getProtoRepositories(req.data.__sqlshell_prototype__);
<font color="#aaaaaa">329:</font>                     res.data.body = renderSkinAsString(<font color="#9999aa">&quot;helma.sqlshell#generate&quot;</font>, p);
<font color="#aaaaaa">330:</font>                 }
<font color="#aaaaaa">331:</font>             }
<font color="#aaaaaa">332:</font>         } else {
<font color="#aaaaaa">333:</font>             res.data.body = renderSkinAsString(<font color="#9999aa">&quot;helma.sqlshell#&quot;</font> + req.data.action, param);
<font color="#aaaaaa">334:</font>         }
<font color="#aaaaaa">335:</font>     } else {
<font color="#aaaaaa">336:</font> <font color="#33aa00">        // should we display type info on some table?
<font color="#aaaaaa">337:</font> </font>        if (req.data.__sqlshell_tab__ == <font color="#9999aa">&quot;explore&quot;</font>) {
<font color="#aaaaaa">338:</font>             param.body = this.explore(meta, schema, param);
<font color="#aaaaaa">339:</font>         } else if (req.data.__sqlshell_tab__ == <font color="#9999aa">&quot;query&quot;</font>) {
<font color="#aaaaaa">340:</font>             param.body = this.query(con, param);
<font color="#aaaaaa">341:</font>         } else if (req.data.__sqlshell_tab__ == <font color="#9999aa">&quot;map&quot;</font>) {
<font color="#aaaaaa">342:</font>             param.body = this.map(meta, schema, con, param);
<font color="#aaaaaa">343:</font>         }
<font color="#aaaaaa">344:</font> <font color="#33aa00">        // render the inner page skin and then the whole page
<font color="#aaaaaa">345:</font> </font>        res.data.body = renderSkinAsString(<font color="#9999aa">&quot;helma.sqlshell#main&quot;</font>, param);
<font color="#aaaaaa">346:</font>     }
<font color="#aaaaaa">347:</font> 
<font color="#aaaaaa">348:</font>     renderSkin(<font color="#9999aa">&quot;helma.sqlshell#page&quot;</font>);
<font color="#aaaaaa">349:</font> }
</pre>
	</td>
</tr>

</table>





</body>
</html>
